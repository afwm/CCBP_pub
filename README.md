# CapCut Batch Processor

## 1. 概要

**CapCutBatchProcessor** は、CapCut のテンプレートプロジェクトと CSV ファイルを使用して、複数の動画プロジェクトを一括で生成するためのデスクトップアプリケーションです。
CSV ファイルで指定された情報（タイトル、テキスト、画像、音声、動画ファイルなど）に基づいて、テンプレート内の要素を自動で差し替えます。

## 2. 主な機能

*   CSV ファイルから読み込んだデータに基づいて、テンプレートを複製し、個別のプロジェクトを生成します。
*   生成されるプロジェクト名は、CSV ファイルの `ProjectName` 列の値に基づきます。
*   プロジェクト内のテキスト要素（`##text_XX##` 形式の目印）を指定したテキストに置換します。
*   プロジェクト内の画像、動画、BGM、ボイス、SE を、CSV で指定されたファイル名に基づいて差し替えます。
*   バッチ生成完了後、生成されたプロジェクト名の一覧を CSV ファイルとして出力します。
*   前回使用したフォルダパスと CSV ファイルパスを記憶し、次回起動時に自動で読み込みます。
*   ライセンス認証機能により、正規ユーザーのみ利用可能です。

## 3. 動作環境

*   **OS:**
    *   macOS (Intel / Apple Silicon)
    *   Windows
*   **その他:** CapCut デスクトップアプリケーションがインストールされている必要があります。

*このアプリケーションはスタンドアロン形式で配布されるため、Python 等を別途インストールする必要はありません。*

## 4. インストールと起動

1.  **.envファイルの準備:** プロジェクトルートに `.env` ファイルを作成し、以下の環境変数を記載してください（例は下記参照）。
    ```env
    LICENSE_API_URL=（発行されたAPIエンドポイント）
    LICENSE_FERNET_KEY=（Fernetキー。Base64で32バイト）
    ```
    * `.env` ファイルは **絶対にGit管理しないでください**。
    * Windows/macOSともに同じ内容でOKです。
2.  **アプリケーションのビルド:**
    * macOS: `bash build_macos.sh` を実行（.envから自動でconfig.jsonが生成され、バンドルに同梱されます）
    * Windows: GitHub Actionsで自動ビルド（Secretsからconfig.jsonが生成され、バンドルに同梱されます）
3.  **起動:**
    * macOS: `nuitka_dist_macos/CCBP.app` をダブルクリック
    * Windows: `nuitka_dist_windows/main.exe` をダブルクリック
4.  **ライセンス認証:**
    * 初回起動時またはキャッシュ無効時にライセンスキー入力を求められます。

## 5. 準備 (重要)

バッチ処理を実行する前に、以下の 3 つを準備する必要があります。

### 5.1. テンプレート CapCut プロジェクト

差し替えの元となる CapCut プロジェクトを作成します。

1.  **新規プロジェクト作成:** CapCut で通常通りプロジェクトを作成します。
2.  **素材の配置と命名規則 (必須):**
    差し替えたい画像、動画、音声ファイルをタイムラインに配置します。
    **重要:** 差し替え対象とする素材には、**必ず以下の命名規則に従ったファイル名**を付けて CapCut にインポートし、配置してください。この名前が CSV ファイルの列名と対応します。

    *   **画像:** `img_00.png`, `img_01.jpg`, `img_02.webp`, ...
    *   **動画:** `video_00.mp4`, `video_01.mov`, ...
    *   **BGM:** `bgm_00.mp3`, `bgm_01.wav`, ...
    *   **ボイス:** `voice_00.mp3`, `voice_01.aiff`, ...
    *   **SE:** `se_00.wav`, `se_01.mp3`, ...

    * `img`, `video`, `bgm`, `voice`, `se` が素材の種類を示します。
    * `_XX` は **必ず 2 桁以上** の連番です (例: `img_00`, `img_01`)。
    * 拡張子は実際のファイルに合わせてください。
3.  **テキスト要素の配置とプレースホルダ (必須):**
    差し替えたいテキスト要素をタイムラインに追加します。
    テキストの内容には、**必ず以下のいずれかのプレースホルダ形式**を使用します。

    *   **CSVファイルの値で置換する場合:** `{{CSV列名}}` (例: `{{text_00}}`, `{{title}}`)
        *   `{{` と `}}` で囲み、中身は CSV ファイルの列名と一致させます。
    *   **素材情報 (material_map) で置換する場合:** `##マップキー##` (例: `##img_00_filename##`, `##duration##`)
        *   `##` で囲み、中身は内部的に生成される素材情報のキーと一致させます (通常は高度な利用向け)。
        *   **基本的なテキスト置換には `{{CSV列名}}` 形式の使用を推奨します。**
    *   フォント、サイズ、位置、効果などは自由に設定できます。
4.  **保存と確認:**
    プロジェクトを保存し、一度 CapCut を終了します。
    **テンプレート確認チェックリスト:**

    *   [ ] 差し替えたいテキストに `##text_XX##` が正しく設定されているか？
    *   [ ] 差し替えたい素材ファイル名が `タイプ_XX.拡張子` になっているか？
    *   [ ] プレビューで意図通り表示・再生されるか？

    作成したテンプレートプロジェクトのフォルダパス（例: `/Users/mbp/Movies/CapCut/User Data/Projects/com.lveditor.draft/TestProject` または `C:\Users\YourUser\AppData\Local\CapCut\User Data\Projects\com.lveditor.draft\TestProject`）を控えておきます。

### 5.2. 素材フォルダ (2 種類)

実際に差し替えに使用する素材ファイルを格納するフォルダを **2 種類** 用意します。

*   **TemplateMaterial (共通素材フォルダ):**
    *   テンプレートプロジェクトで使用している**全ての素材**を、このフォルダの下に作成した「テンプレートプロジェクト名のフォルダ」内にコピーします。
    *   素材の種類ごとにサブフォルダ (`img`, `video`, `bgm`, `voice`, `se`) を作成して格納します。
    *   **構造例:**
        ```
        TemplateMaterial/
         └── (テンプレートプロジェクト名)/
               ├── img/
               │   └── img_00.png (テンプレートで使った素材)
               ├── video/
               │   └── video_00.mp4 (テンプレートで使った素材)
               ...
        ```
*   **ChangeMaterial (個別差し替え素材フォルダ):**
    *   プロジェクトごとに**差し替えたい固有の素材**を格納します。
    *   このフォルダの**直下**に、CSV の `ProjectName` と同じ名前のサブフォルダを作成します。
    *   さらにその中に、素材タイプ別のサブフォルダ (`img`, `video`, `bgm`, `voice`, `se`) を作成し、差し替えたい素材ファイルを配置します。
    *   **構造例:**
        ```
        ChangeMaterial/
        ├── project_00001/ (CSVのProjectNameと一致)
        │   ├── img/
        │   │   └── title_image_001.png (差し替えたい画像)
        │   ├── voice/
        │   │   └── narration_001.wav (差し替えたい音声)
        │   ...
        ├── project_00002/
        │   ├── img/
        │   │   └── title_image_002.jpg
        │   ...
        ...
        ```

### 5.3. CSV ファイル

差し替え情報を定義する CSV ファイルを作成します (Excel や Google スプレッドシート等で作成可能)。

*   **文字コード:** UTF-8 (BOM 付き推奨)
*   **必須列:**
    *   `id`: 各行を識別するための一意な ID。
    *   `ProjectName`: 生成するプロジェクト名。ChangeMaterial 内のフォルダ名と一致させる必要があります。
*   **任意列 (素材差し替え用):**
    *   **列名:** テンプレート内の素材命名規則に合わせて定義します (例: `img_00`, `img_01`, `voice_00` など)。
    *   **値:** 差し替えたい場合は、その列に対応する**ファイル名（拡張子込み）**を記入します。ツールはこのファイル名を ChangeMaterial から探します。
    *   **空欄:** 空欄の場合は、TemplateMaterial 内の共通素材が使用されます。
*   **任意列 (テキスト差し替え用):**
    *   **列名:** テンプレート内のプレースホルダ `{{CSV列名}}` に対応する CSV 列名を定義します (例: `text_00`, `title`)。
    *   **値:** プレースホルダを置換する実際のテキストを記入します。

**CSV サンプル:** (`doc/sample.csv` を参照)

---

## 6. 使い方 (GUI)

1.  上記「インストールと起動」の手順で GUI アプリケーションを起動します。
2.  GUI が起動したら、以下のパスを設定します (初回起動時や前回設定がクリアされた場合は空欄です)。
    *   **【ファイル指定】バッチ用 CSV ファイル:** 準備 5.3 で作成した CSV ファイル。
    *   **【フォルダ指定】テンプレートプロジェクト:** 準備 5.1 で作成したテンプレートプロジェクトのフォルダ。
    *   **【フォルダ指定】テンプレート素材フォルダ:** 準備 5.2 で用意した `TemplateMaterial` フォルダ。
    *   **【フォルダ指定】個別差し替え素材まとめフォルダ:** 準備 5.2 で用意した `ChangeMaterial` フォルダ。
    *   **【フォルダ指定】生成プロジェクトの出力先:** 生成されたプロジェクトを保存するフォルダ (CapCut が認識するプロジェクトフォルダ推奨、例: `~/Movies/CapCut/User Data/Projects/com.lveditor.draft` または `C:\...\CapCut\User Data\Projects\com.lveditor.draft`)。
    *   **【フォルダ指定】バッチ処理完了報告 CSV の出力先:** 生成プロジェクト一覧 CSV の出力先フォルダ。
3.  **「バッチ生成実行」** ボタンをクリックします。
4.  処理が開始され、進捗がプログレスバーとログエリアに表示されます。
5.  完了するとメッセージボックスが表示され、ログエリアに結果の詳細が表示されます。
6.  成功した場合、「バッチ処理完了報告 CSV の出力先」で指定したフォルダ内に `generated_projects_YYMMDD_HHMMSS.csv` が出力されます。

---

## 7. 素材検索の仕組み (補足)

ツールは、テンプレート内の素材パス (例: `/path/to/template/img/img_00.png`) を処理する際に、ファイル名 (`img_00.png`) や素材 ID (`img_00`) などをキーとして、事前に構築した「素材マップ」から差し替え後のパスを検索します。

この「素材マップ」は以下の情報源から構築されます:
1.  **CSV ファイル:** CSV の各行について、素材を示す列 (例: `img_00`, `bgm_00`) にファイル名が指定されている場合、その情報がマップに追加されます。ツールは、まず `ChangeMaterial` フォルダからそのファイルを探します (例: `ChangeMaterial/{ProjectName}/img/指定されたファイル名`)。
2.  **ChangeMaterial フォルダ:** CSV で指定されていない素材についても、`ChangeMaterial/{ProjectName}/` 以下に対応する素材ファイルが存在すれば、マップに追加されます。
3.  **TemplateMaterial フォルダ:** 上記で見つからなかった素材は、`TemplateMaterial/{テンプレート名}/` 以下から探され、マップに追加されます。

**検索の優先順位:** 基本的に **CSV で指定されたファイル (ChangeMaterial 内) > ChangeMaterial 内のファイル > TemplateMaterial 内のファイル** の順で優先され、最初に見つかった素材のパスが最終的にプロジェクトファイルに書き込まれます。

**重要:** TemplateMaterial にテンプレートで元々使われていた素材が正しくコピーされていないと、参照すべきファイルが見つからず、CapCut で開いた際に「メディアが見つかりません」となる可能性があります。

---

## 8. トラブルシューティング

1.  **アプリケーションが起動しない:** ダウンロードしたファイルが破損していないか確認してください。セキュリティソフトによってブロックされていないか確認してください。
2.  **パス指定エラー (GUI):** 指定した各パス（CSV, 各フォルダ）が存在するか、入力ミスがないか確認してください。特にフォルダパスの末尾に不要なスペースなどが入っていないか注意してください。
3.  **実行時エラー: 素材が見つからない / フォルダが見つからない:**
    *   CSV の `ProjectName` と ChangeMaterial 内のフォルダ名が完全に一致しているか確認してください (大文字/小文字、スペース等)。
    *   ChangeMaterial のパス指定が正しいか確認してください。
    *   CSV で指定したファイル名が ChangeMaterial または TemplateMaterial 内に実際に存在するか確認してください。
    *   各素材フォルダのサブフォルダ名 (`img`, `video` など) が正しいか確認してください。
    *   ログエリアの警告メッセージ (`素材が見つかりません` など) を確認してください。
4.  **差し替えが期待通りに行われない:**
    *   **テンプレート内の素材ファイル名** (`タイプ_XX.拡張子`) や**テキストプレースホルダ** (`##text_XX##`) が命名規則通りか再確認してください。
    *   **CSV ファイルの列名**がテンプレートの命名規則と一致しているか確認してください。
5.  **生成されたプロジェクトが CapCut で開けない / 破損している:**
    *   プロジェクト出力先フォルダの指定が正しいか（CapCut が認識できる場所か）確認してください。
    *   処理中に CapCut が起動していなかったか確認してください (可能な限り終了させておくことを推奨します)。
    *   テンプレートプロジェクト自体が正常に開けるか確認してください。
6.  **ライセンス認証エラー:** 入力したライセンスキーが正しいか確認してください。ネットワーク接続が必要な場合があります。問題が続く場合は、サポートにお問い合わせください。

---

## 9. 注意事項

*   **CapCut 依存:** このツールは CapCut のプロジェクト構造に依存しています。CapCut のアップデートにより構造が大幅に変更された場合、動作しなくなる可能性があります。
*   **上書き注意:** 出力先に同名のプロジェクトフォルダが存在する場合、**確認なしに削除・上書きされます。** 必要なプロジェクトは事前にバックアップしてください。
*   **処理中の応答:** バッチ生成処理中でも UI の応答性は維持されますが、大量のファイルを処理する場合、完了までには時間がかかることがあります。

## 10. ライセンス

*   **本アプリケーション (CapCutBatchProcessor):** プロプライエタリ ライセンス (All Rights Reserved)。
*   **同梱ライブラリ:** PySide6 (LGPLv3) 他。詳細は各ライブラリのライセンスを参照。

---

## .envファイル例

```
LICENSE_API_URL=https://script.google.com/macros/s/xxx/exec
LICENSE_FERNET_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx==
```

- `.env` はビルド時に自動で読み込まれ、`config.json` が生成されます。
- `LICENSE_SECRET_KEY` は不要になりました。
- Secretsやキー情報は絶対にリポジトリにコミットしないでください。

## 11. サポート

不具合や要望については、[問題報告の方法、例: GitHub Issues へご連絡ください / または指定の連絡先]。

## ビルド・配布

### macOS（ローカルビルド）
- `build_macos.sh` を使用し、App Bundle形式（.app）でビルドします。
- 必要な環境変数は `.env` に記載し、`config.json` はビルド時に自動生成されます。
- 実行手順：
  ```bash
  cp .env.example .env # 必要に応じて
  bash build_macos.sh
  # 成果物: nuitka_dist_macos/CCBP.app
  ```

### Windows（GitHub ActionsによるCIビルド）
- `.github/workflows/windows_build.yml` でNuitkaビルドを自動化しています。
- Secrets（`LICENSE_API_URL`, `LICENSE_FERNET_KEY`）から `config.json` を自動生成し、成果物をArtifactとしてアップロードします。
- 手動ビルドは推奨されません。CI経由で成果物をダウンロードしてください。

### ビルド成果物
- macOS: `nuitka_dist_macos/CCBP.app`
- Windows: `nuitka_dist_windows/main.dist/` 以下の実行ファイル一式

### 注意点
- macOSでは `--onepackage`/`--onefile` は未サポートです。App Bundle形式のみ対応。
- Windowsでは `--standalone` 形式でビルドされます。
- `.env` や `config.json` などの機密情報はGit管理しないでください。

## 開発・詳細ドキュメント
- 詳細な開発手順や設計方針は [DEVELOPMENT.md](DEVELOPMENT.md) を参照してください。
